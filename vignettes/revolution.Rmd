---
title: "revolution"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{revolution}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(revolution)
```

## Loading and updating the underlying data

The "revolution" package offers the possibility to manually update the underlying data, so that the plots of time series like the 7-day-incidence or the vaccination data are always up to date. To update the official data from the German federal agency for disease control (RKI), the function `update_rki_data()` should be called.

Basically, all the functions except the ones that plot data of vaccines and "variants of concerns" use this data set, so recommended to call `update_rki_data()` regularly.

To update the data for vaccine-related tibbles or plots, the function `update_vac_data()` should be called.

Furthermore, the RKI offers data for "variants of concerns", so e.g. the delta-variant. To update this data set, call `update_voc_data()`.

## The official RKI data set

Most of the functions provided by "revolution" obtain their data by the official RKI csv file. Unfortunately, the data set is not without errors and it heavily relies on the reporting capabilities of the local health offices. E.g., the number of reported cases fluctuates drastically within one week due to the fact that most of the health offices and laboratories do not work full-time on Sundays. Furthermore, less people are tested during the weekend, what distorts the numbers as well.

The RKI data set provides the date the case was reported by the health office for each case. For about half of them, the data set also lists the infection date. In the following, the cases for which the infection date is known will be called "traced". 

The function `calc_traced_cases()` returns a time series that contains the total and relative amount of traced cases for each day since 2020. The specification of age groups and regions (districts and states) is possible.

```{r}
calc_traced_cases(ages="all",region="Baden-W端rttemberg",from="2020-03-01")
```

Based on `calc_traced_cases()`, the two plot functions `plot_traced_cases_percentage` and `plot_traced_cases_total` visualize the upper tibble.

## COVID-19 associated deaths and cases

The RKI data is huge (more than 2 000 000 rows and more than 300 MB that are only made up of letters, digits and commas). Thus, it offers countless possibilities of statistical analysis, some of the most famous or useful are included in this package. These function often come in pairs: one delivers the time series (so it returns a tibble), the other returns the belonging plot to visualize the time series.

One of the most important functions in this context seems to be `get_data_for()`. This function allows various extractions of the RKI data, the user can define the desired age group, region and the beginning and the end of the time series that `get_data_for()` returns:

```{r}
get_data_for(regions=c("Heidelberg","Mannheim"),ages=c(15,52,84),from="2020-12-02",to="2021-08-05",type="cases")
```
The belonging plot function is `plot_data_for()`, so the plot for the upper example looks like this:

```{r show_figure fig.width=8}
plot_data_for(regions=c("Heidelberg","Mannheim"),ages=c(15,52,84),from="2020-12-02",to="2021-08-05",type="cases")
```

In this example, the data contains the absolute number of cases, but `get_data_for()` and `plot_data_for()` also offer the possibility to get the 7-day-incidence or the number of COVID-19 associated deaths.

Similar functions are `get_sti_series_for()` and `get_time_series_for()`. 
`get_sti_series_for()` returns a time series of the 7-day-incidence and it is possible to get a "7-day-death-incidence". `get_time_series_for()` returns a time series for the absolute number of cases and COVID-19 associated deaths. In contrast to `get_data_for()`, it delivers a single tibble. 

The package also offers a nice visualization of the age distribution during the pandemic: `plot_for_agegroups()` can be called with `type="cases"` or with `type="sti"`.
```{r}
plot_for_agegroups(type="cases")
```

During the pandemic, several virus variants showed up. They all differ in characteristics like the contagiosity or the mortality. To show the influence of the so called "variants of concern", "revolution" has the functions `variant_case_time_series()`, `variant_case_r_value()` and `variant_sti_time_series()`. These functions all return tibbles that contain the data that the function names indicate for each variant of concern. The function `plot_variants()` delivers the belonging plots. 

Unfortunately, the official RKI table only contains weekly data. Hence, `plot_variants()` tries to interpolate the weekly data points to estimate the daily share of the different variants. `plot_variants()`is able to plot either the absolute number, the r-value, the 7-day-incidence or the share of each single variant.

```{r}
plot_variants(interpolation="linear",type="share")
```
## Factors influencing the spread

The way COVID-19 spread during the last months is diffuse. One of the biggest problems with identifying influential factors is the large dark figure and the classical saying "correlation is not causality". There is a huge amount of possible factors (i.e. seasonality and weather, travel behaviour of the population, mandatory mask wearing, lockdown, etc.). "revolution" takes a closer look at three factors: the income, the geographical proximity between districts and the population density of districts.

To study the correlation between income and COVID-19 incidence, the function `income_sti_correlation()` comes in handy. It returns a time series of correlation coefficients between the average income of districts and the 7-day-incidence.
At first glance, the result seem promising and significant. But after a more precise study, it turned out that the correlation between income and 7-day-incidence mostly depends on the fact that COVID-19 spread further in East Germany, where the population is rather poor due to its history. 

To check the other guess that geographical proximity plays an important role in the spread of COVID-19 (especially concerning the case hot-spots), the function `calc_sti_correlation_of_lks()` returns a tibble that contains all the correlation coefficients between the 7-days-incidence of districts.

```{r}
calc_sti_correlation_of_lks(c("Heidelberg","Mannheim","Hamburg"))
```
All in all, all of the districts show a rather high correlation because the geographical spread of COVID-19 is quite uniform. Furthermore, the correlation as a single number needs to be handled carefully: e.g. a hotspot in Hamburg and Munich during the same time period would lead to a high correlation, even though the origin of the outbreak could be totally different.

The third important function in this context is `get_pop_density_with_sti()` (and for plotting with a linear model: `plot_pop_density_with_linear_model()`). The former just returns a tibble of the 7-days-incidence and the population density of a tibble, the latter delivers a linear model in order to identify a possible correlation between population density and the 7-days-incidence.

```{r}
plot_pop_density_with_linear_model(c("Heidelberg","Mannheim","Nordfriesland","Schleswig-Flensburg","Hamburg","M端nchen"))
```
This data evaluation delivers similar results as the other analsyis functions: a clear correlation cannot be identified. Of course, one can find highly populated districts that also show high COVID-19 rates and a general trend is recognizable. But on the other hand, there are many districts that draw a contrary picture: high population density and low COVID-19 incidence or low density and high incidence. 
All in all, there are simply too many influence factors that are not covered by these three functions, so "revolution" alone is not sufficient for a deep study of influential factors. 

## COVID-19 vaccine data

In December of 2020, an influential and deciding factor was introduced to fight the pandemic: the vaccine. "revolution" offers the functionality to show the current vaccination progress. 

Therefore, "revolution" has the function `get_vaccination_data()` (and for plotting: `plot_vaccination_data()`). It is possible to specify the desired age group, the districts and states, the time period, the vaccination status (so data is filtered by first or second vaccination) and it is possible to sum up the vaccination numbers to get cumulated figures.

```{r}
get_vaccination_data(ages="18-59",regions=c("Niedersachsen","Sachsen"),from="2020-12-26",to="2021-08-07",vac_num=1,cumulate=F)
```
The belonging plot looks like this:
```{r}
plot_vaccination_data(ages="18-59",regions=c("Niedersachsen","Sachsen"),from="2020-12-26",to="2021-08-07",vac_num=1,cumulate=F)
```
Some of the plotting functions have the possibility to smooth the time series. Always check the documentation to see whether smoothing is possible or not.

```{r}
plot_vaccination_data(ages="18-59",regions=c("Niedersachsen","Sachsen"),from="2020-12-26",to="2021-08-07",vac_num=1,cumulate=F,smoothing=3)
```

## Deaths and excess mortality

In total, there are more than 90 000 COVID-19 associated deaths in Germany (in August 2021). This is an extremely high number, far higher than the documented influenza associated deaths. To study the effect of COVID-19 on the general mortality in Germany, "revolution" provides several functions.

Firstly, the function `calc_covid_mortality()` is useful in order to clearly identify the most vulnerable age groups. This function calculates the mortality of COVID-19, so for each day, it returns the quotient of deaths and infections per age group.

```{r}
calc_covid_mortality(ages=80, regions="Baden-W端rttemberg",from="2020-03-15")
```
The belonging plot looks like this:
```{r}
plot_covid_mortality(ages=80, regions="Baden-W端rttemberg",from="2020-03-15",smoothing=2)
```
The plot shows that in the beginning of the COVID-19 pandemic the mortality was quite high. This aspect can be explained by the fact that the reporting system was too slow at first, what lead to a high dark figure. 
The effects of the vaccination are also visible, obviously, the mortality has been sinking since the second quarter of 2021.

The function `get_abs_deaths()` returns the absolute number of daily deaths in Germany. The user decides, which years should be returned, the earliest data are from 2000, the latest from 2020.
```{r}
get_abs_deaths(years=c(2000,2019,2020))
```

As always, "revolution" provides the belonging function to plot this tibble:
```{r}
plot_abs_deaths(years=c(2003,2019,2020),smoothing=0)
```
In contrast to previous years, an exceedingly high number of absolute deaths at the end of the year is significantly recognizable in 2020.

The data set on which the upper function relies on does not contain any information about the number of deaths in different age groups, but there exists data that splits up the weekly number of deaths by ages. Unfortunately, the earliest possible year is 2014. 
The function `get_weekly_deaths()` prepares that data set and returns a tibble filtered by the desired years and age groups. Additionally, it has the feature to divide the weekly number of deaths by the population to calculate a "weekly mortality rate".
To plot this tibble, call `plot_weekly_deaths()`:
```{r}
plot_weekly_deaths(c(2018,2019,2020),age="A60-A79")
```
As expected, the weekly number also shows a strong rise of deaths at the end of 2020, but e.g. in the age group "A60-A79", the number of weekly deaths did not increase as much as during the flu epidemic of 2018.

In order to give context to the mortality in 2020, "revolution" provides the function `get_total_mortality()`. For each year since 2014, it calculates the mortality per age group over the whole year.
```{r}
plot_total_mortality(age="A80+")
```
Obviously, the mortality in 2020 wasn't significantly high, even though the plot shows the most vulnerable age group "A80+". But it is important to consider the fact that the total mortality is calculated with accumulated deaths over the whole year. Thus, seasonal effects (COVID-19 is seasonal) can be compensated by a low number of deaths in another time of the year. In 2020 e.g., the upper plots show a quite weak flu pandemic at the beginning of the year.

A pretty popular way to measure excess mortality is the comparison between one specific year (for COVID-19, one chooses 2020 of course) and the average deaths per day of the previous years (this is how the "Statistisches Bundesamt" measures excess mortality). To visualize this comparison, the function `plot_excess_mortality`can be used.
```{r}
plot_excess_mortality(2020,c(2016,2017,2018,2019),smoothing=1)
```
Looking at this plot, it becomes crystal clear that winter 2020/2021 showed a significant excess mortality. At this point it is important to note that the average must not be calculated with too early years, because otherwise demographic changes and an aging society would distort the comparison:

```{r}
plot_excess_mortality(2020,c(2000,2001,2002,2003),smoothing=1)
```
